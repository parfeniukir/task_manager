# Pre-commit hooks у Django проєкті
Цей документ пояснює, що таке **pre-commit hooks** і як їх використовувати в Django-проєкті, щоб автоматично запускати перевірки і тести перед кожним `git commit`.

---
## Що таке pre-commit
**Pre-commit** — це механізм Git, який дозволяє автоматично виконувати перевірки **перед створенням коміту**.
Якщо перевірки не проходять:
- коміт **блокується**
- ви одразу бачите проблему
- код не потрапляє в репозиторій у зламаному стані

---
## Навіщо потрібен pre-commit
Pre-commit допомагає:
- запобігати комітам з помилками
- гарантувати, що тести проходять перед комітом
- дисциплінувати робочий процес
- зменшити кількість багів у репозиторії
- не покладатися тільки на “я перевірив вручну”

---
## Де працює pre-commit
- pre-commit працює **локально** на вашому компʼютері
- він запускається **до створення коміту**
- він **не замінює CI**, але доповнює його

---
## Загальна логіка роботи
Робочий процес виглядає так:
1. Ви пишете код
2. Виконуєте `git commit`
3. Git викликає pre-commit
4. Pre-commit запускає перевірки (тести)
5. Якщо все добре — коміт створюється
6. Якщо є помилки — коміт зупиняється

---
## Що саме можна перевіряти через pre-commit
Через pre-commit можна запускати:
- unit tests
- перевірку форматування коду
- перевірку стилю
- перевірку конфігураційних файлів
- будь-які кастомні команди

У нашому проєкті pre-commit використовується для **запуску Django тестів** форматерів та літрерів.

---
## Як підключається pre-commit (загальна схема)

### 1 Встановіть `pre-commit` у проєкт

1. Додайте `pre-commit` у залежності (краще в `requirements-dev.txt` або в основний `requirements.txt`, якщо вам так простіше для курсу).

2. Встановіть залежності у venv
Приклад команд:

```
pip install pre-commit
```

### 2 Створіть файл `.pre-commit-config.yaml` у корені проєкту

У корені (де `manage.py`) створіть файл `.pre-commit-config.yaml`:

```yaml
repos:
  - repo: local
    hooks:
      - id: django-tests
        name: Run Django tests
        entry: python manage.py test
        language: system
        pass_filenames: false
        stages: [pre-commit]
  - repo: https://github.com/timothycrosley/isort
    rev: 5.12.0
    hooks:
    - id: isort
      additional_dependencies: [toml]
  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
    - id: black
  - repo: https://github.com/pycqa/flake8
    rev: 6.0.0
    hooks:
    - id: flake8
```

Пояснення важливих полів:
1. `repo: local` - це ваш власний hook
2. `language: system` - використовує Python з вашого активного venv
3. `pass_filenames: false` - щоб не передавались імена файлів (Django tests їх не очікує)
4. `entry: python manage.py test` - команда, яка реально запускається

### 3 Увімкніть hook у git репозиторії

Виконайте:
```
pre-commit install
```
Це створить git hook у `.git/hooks/pre-commit`, який буде викликати `pre-commit` автоматично.

### 4 Перевірте, що все працює

1. Запустіть вручну один раз (корисно для перевірки):
```
pre-commit run --all-files
```
2. Зробіть будь-яку зміну у файлі, і спробуйте `git commit`.
3. Якщо тести не проходять - коміт буде зупинений, поки ви не виправите помилки.

### 5 Як зробити швидше для студентів (рекомендація)

Якщо у вас тести довгі, можна запускати тільки `tasks`:
Змініть рядок `entry` на:

`entry: python manage.py test tasks`

Або запускати тільки найважливіший набір (наприклад, tasks + accounts), якщо у вас так організовано.

### 6 Як пропустити hook (на крайній випадок)

Якщо комусь терміново треба закомітити, можна пропустити hook:
```
git commit -m "message" --no-verify
```
Це варто дозволяти тільки як виняток, так краще не робити регулярно.

### 7 Типові проблеми і рішення

1. Hook не бачить залежності Django
    - переконайтесь, що коміт робиться з активованого venv
2. Команда `python` у hook запускає “не той” Python
    - на macOS інколи краще вказати `entry: python3 manage.py test`
3. Хук падає через відсутні міграції
    - переконайтесь, що міграції зроблені і код не ламає запуск тестової БД

---

## Як це виглядає для Django проєкту
У Django pre-commit зазвичай використовується для:
- запуску `python manage.py test`
- блокування коміту, якщо тести не проходять

Таким чином:
- у репозиторій не потрапляє код з падаючими тестами
- кожен коміт залишається стабільним

---

## Важливо памʼятати
- pre-commit працює тільки якщо ви **активували віртуальне середовище**
- pre-commit не запускається автоматично без встановлення
- hook можна пропустити, але робити це не рекомендується
- у реальних проєктах pre-commit — стандартна практика

---
## Часті питання
### Чи замінює pre-commit CI?
Ні.
Pre-commit — це **локальний захист**, CI — **серверна перевірка**.

---
### Чи може pre-commit бути повільним?
Так, якщо тести великі.
У таких випадках запускають:
- частину тестів
- або тільки тести конкретного застосунку

---
### Чи обовʼязково його використовувати?
Для навчання — ні.
Для реальної розробки — дуже бажано.

---
## Короткий підсумок
- Pre-commit — це автоматичні перевірки перед комітом
- Він допомагає зберігати код стабільним
- У Django найчастіше запускає тести
- Це хороша звичка для реальних проєктів